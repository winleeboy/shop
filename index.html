

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cigautrom.</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root {
            --bg: #1c1c1e;
            --text: #ffffff;
            --hint: #8e8e93;
            --link: #007aff;
            --card-bg: #2c2c2e;
            --active-heart: #ff3b30;
        }

        /* –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ë–õ–û–ö –°–í–ê–ô–ü–ê */
        html, body { 
            height: 100%; 
            overflow: hidden; 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 0; 
            -webkit-tap-highlight-color: transparent;
            /* –®–†–ò–§–¢–´ –ò–ó 30-–π –í–ï–†–°–ò–ò (–°–ò–°–¢–ï–ú–ù–´–ï) */
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif; 
        }
        
        ::-webkit-scrollbar { display: none; }

        /* --- –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –ö–û–ù–¢–ï–ô–ù–ï–† –° –•–ê–ö–û–ú (–î–õ–Ø –ì–õ–ê–í–ù–û–ô) --- */
        .scroll-container {
            height: 100%;
            overflow-y: scroll; 
            -webkit-overflow-scrolling: touch;
            padding-bottom: 120px; /* –ú–µ—Å—Ç–æ –ø–æ–¥ –º–µ–Ω—é */
            box-sizing: border-box;
            position: absolute; top: 0; left: 0; width: 100%;
        }
        /* –•–∞–∫: –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ 101% –≤—ã—Å–æ—Ç—ã */
        .scroll-container::after {
            content: ""; display: block; height: 1px; width: 100%; min-height: calc(100% + 1px);
        }

        /* --- –®–ê–ü–ö–ê --- */
        .header { 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            background: rgba(28,28,30,0.98); 
            border-bottom: 0.5px solid rgba(255,255,255,0.1);
            padding-top: calc(60px + env(safe-area-inset-top)); 
            padding-bottom: 10px;
        }

        .top-bar {
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 15px; position: relative; height: 32px;
        }

        .brand-logo {
            width: 32px; height: 32px; border-radius: 50%;
            object-fit: cover; position: absolute; left: 15px; background: #333;
        }

        .app-title { font-weight: 700; font-size: 22px; letter-spacing: -0.5px; color: #fff; display: flex; align-items: baseline; justify-content: center; }
        .dot-accent { color: var(--text); font-size: 22px; }

        /* –§–ò–õ–¨–¢–†–´ */
        .filters-row { display: flex; gap: 8px; overflow-x: auto; padding: 0 15px; align-items: center; scrollbar-width: none; }
        .filters-row::-webkit-scrollbar { display: none; }
        
        .pill { background: var(--card-bg); color: var(--text); border: none; padding: 10px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; white-space: nowrap; cursor: pointer; transition: 0.1s; display: flex; align-items: center; justify-content: center; }
        .pill.active { background: var(--text); color: var(--bg); }
        
        .sort-wrapper { position: relative; width: 44px; height: 36px; background: var(--card-bg); border-radius: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-right: -2px; }
        .sort-icon { font-size: 18px; color: var(--text); pointer-events: none; font-weight: 300; }
        .sort-select { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; z-index: 10; cursor: pointer; }

        /* --- –°–ï–¢–ö–ê --- */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px 10px; padding: 15px 10px; align-items: start; }
        .card { display: flex; flex-direction: column; position: relative; width: 100%; }
        
        .card-slider { width: 100%; aspect-ratio: 1 / 1; border-radius: 16px; overflow-x: auto; overflow-y: hidden; display: flex; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; background: var(--card-bg); position: relative;}
        .card-slide { min-width: 100%; height: 100%; scroll-snap-align: center; }
        .card-slide img { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        .dots-row { display: flex; justify-content: center; gap: 4px; margin-top: 8px; margin-bottom: 4px; height: 6px;}
        .c-dot { width: 5px; height: 5px; background: #3a3a3c; border-radius: 50%; }
        .c-dot.active { background: #ffffff; }

        .card-info { padding: 0 2px; margin-top: 2px; }
        .price { font-weight: 700; font-size: 16px; color: #fff; line-height: 1.2; margin-bottom: 4px; }
        .name { font-size: 14px; font-weight: 600; color: #d1d1d6; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 36px; }
        
        .fav-icon-svg { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; z-index: 20; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); cursor: pointer; transition: transform 0.1s; }
        .fav-icon-svg:active { transform: scale(0.8); }
        .fav-icon-svg path { fill: rgba(0,0,0,0.3); stroke: white; stroke-width: 1.5; transition: fill 0.2s, stroke 0.2s; }
        .fav-icon-svg.liked path { fill: var(--active-heart); stroke: var(--active-heart); }

        .badge-new { position: absolute; top: 8px; left: 8px; background: #30d158; color: #000; font-size: 10px; font-weight: 800; padding: 4px 6px; border-radius: 6px; z-index: 10; pointer-events: none; }

        /* --- –°–¢–ê–¢–¨–Ø --- */
        .article-view { padding: 20px; display: none; animation: fadeIn 0.3s; padding-bottom: 150px; position: relative; z-index: 2;}
        .article-title { font-size: 22px; font-weight: 700; margin-bottom: 20px; line-height: 1.3; }
        .article-text { font-size: 16px; line-height: 1.6; color: #d1d1d6; white-space: pre-wrap; }
        .article-btn-container { margin-top: 30px; }

        /* --- MODAL (–¢–û–í–ê–†) --- */
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg); z-index: 100; 
            transform: translateX(100%); transition: transform 0.25s cubic-bezier(0.1, 0.7, 0.1, 1); 
            display: flex; flex-direction: column; 
        }
        .modal.open { transform: translateX(0); }
        
        /* –í–û–¢ –û–ù: –¢–û–¢ –ñ–ï –•–ê–ö, –ß–¢–û –ò –ù–ê –ì–õ–ê–í–ù–û–ô, –ù–û –í–ù–£–¢–†–ò –¢–û–í–ê–†–ê
           –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–∏—Ç –º–æ–¥–∞–ª–∫—É —Å–∫—Ä–æ–ª–ª–∏—Ç—å—Å—è, –∞ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å—Å—è
        */
        .modal-scroll-area {
            flex: 1; 
            overflow-y: scroll; 
            -webkit-overflow-scrolling: touch;
            
            /* –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É (—á—Ç–æ–±—ã –Ω–µ –ª–µ–∑–ª–æ –ø–æ–¥ —à–∞–ø–∫—É) */
            padding-top: calc(60px + env(safe-area-inset-top));
            padding-left: 20px; padding-right: 20px; padding-bottom: 20px;
        }
        /* –†–ê–°–ü–û–†–ö–ê –í–ù–£–¢–†–ò –¢–û–í–ê–†–ê */
        .modal-scroll-area::after {
            content: ""; display: block; height: 1px; min-height: calc(100% + 1px); width: 100%;
        }

        .gallery-container { 
            position: relative; width: 100%; padding-top: 100%; 
            background: #000; overflow: hidden; border-radius: 24px; 
            margin-top: 0; 
        }
        .gallery-track { position: absolute; top: 0; left: 0; height: 100%; display: flex; transition: transform 0.3s ease-out; }
        .gallery-item { min-width: 100%; width: 100%; height: 100%; position: relative; }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
        
        .modal-dots { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; gap: 6px; pointer-events: none; }
        .m-dot { width: 6px; height: 6px; background: rgba(255,255,255,0.4); border-radius: 50%; }
        .m-dot.active { background: #fff; transform: scale(1.2); }

        .modal-fav-pos { position: absolute; top: 15px; right: 15px; width: 28px; height: 28px; z-index: 20; }

        .m-header { margin-bottom: 15px; margin-top: 15px; }
        .m-price { font-size: 26px; font-weight: 800; color: #fff; margin-bottom: 8px; letter-spacing: -0.5px;}
        .m-name { font-size: 18px; font-weight: 600; line-height: 1.4; color: #d1d1d6; }
        .separator { height: 1px; background: rgba(255,255,255,0.1); width: 100%; margin: 15px 0; }
        .m-desc { color: #fff; font-size: 15px; line-height: 1.6; white-space: pre-wrap; opacity: 0.9; padding-bottom: 20px; }

        /* –ö–ù–û–ü–ö–ê –§–ò–ö–°–ò–†–û–í–ê–ù–ê */
        .modal-actions { 
            flex-shrink: 0; padding: 15px 16px; 
            border-top: 1px solid rgba(255,255,255,0.05); 
            background: var(--bg); 
            padding-bottom: calc(20px + env(safe-area-inset-bottom)); 
            z-index: 101;
        }
        .btn-main { display: flex; width: 100%; background: var(--link); color: white; height: 50px; border-radius: 14px; align-items: center; justify-content: center; font-weight: 600; text-decoration: none; font-size: 16px; }

        /* --- LIGHTBOX (–ó–£–ú) - –ö–†–ï–°–¢–ò–ö –ù–ò–ñ–ï --- */
        .lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 200; display: none; flex-direction: column; opacity: 0; transition: opacity 0.3s; }
        .lightbox.show { display: flex; opacity: 1; }
        .lb-track { display: flex; height: 100%; transition: transform 0.3s ease-out; }
        .lb-item { min-width: 100vw; height: 100%; display: flex; align-items: center; justify-content: center; }
        .lb-item img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        /* –û–ü–£–°–¢–ò–õ –ö–†–ï–°–¢–ò–ö –ù–ê 140px */
        .close-zoom { position: absolute; top: 140px; right: 20px; width: 44px; height: 44px; background: rgba(50,50,50,0.8); border-radius: 50%; color: white; font-size: 28px; display: flex; align-items: center; justify-content: center; z-index: 210; cursor: pointer; font-weight: 300; }
        .lb-counter { position: absolute; top: 150px; left: 20px; color: white; font-weight: 600; font-size: 16px; z-index: 210;}

        /* --- TAB BAR --- */
        .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #1c1c1e; border-top: 0.5px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; padding-top: 10px; padding-bottom: calc(20px + env(safe-area-inset-bottom)); z-index: 80; }
        .tab-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--hint); width: 50%; cursor: pointer;}
        .tab-item.active { color: #fff; }
        .tab-icon svg { width: 26px; height: 26px; fill: none; stroke: var(--hint); stroke-width: 2; transition: stroke 0.2s; }
        .tab-item.active .tab-icon svg { stroke: #fff; }
        
        .hidden { display: none !important; }

        /* --- TOAST --- */
        .toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(20px); background: #ffffff; color: #000; padding: 10px 20px; border-radius: 12px; font-size: 14px; font-weight: 600; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 150; box-shadow: 0 4px 15px rgba(0,0,0,0.4); white-space: nowrap; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div id="toast" class="toast">–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</div>

    <div id="lightbox" class="lightbox">
        <div class="lb-counter" id="lb-counter">1 / 5</div>
        <div class="close-zoom" onclick="closeZoom()">‚úï</div>
        <div class="lb-track" id="lb-track"></div>
    </div>

    <div id="screen-home" class="scroll-container">
        <div class="header">
            <div class="top-bar">
                <img id="brand-logo" class="brand-logo" src="" style="display:none">
                <div class="app-title">Cigautrom<span class="dot-accent">.</span></div>
            </div>

            <div class="filters-row">
                <div class="sort-wrapper">
                    <div class="sort-icon">‚áÖ</div>
                    <select class="sort-select" onchange="applySort(this.value)">
                        <option value="new">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                        <option value="asc">–°–Ω–∞—á–∞–ª–∞ –¥–µ—à–µ–≤—ã–µ</option>
                        <option value="desc">–°–Ω–∞—á–∞–ª–∞ –¥–æ—Ä–æ–≥–∏–µ</option>
                        <option value="avito">–° –ê–≤–∏—Ç–æ–¥–æ—Å—Ç–∞–≤–∫–æ–π</option>
                    </select>
                </div>
                <button class="pill active" onclick="setCategory('all', this)">–í—Å–µ</button>
                <button class="pill" onclick="setCategory('bags', this)">–°—É–º–∫–∏</button>
                <button class="pill" onclick="showArticle(this)">–ü–æ–¥ –∑–∞–∫–∞–∑</button>
                <button class="pill" onclick="setCategory('jackets', this)">–ö—É—Ä—Ç–∫–∏</button>
                <button class="pill" onclick="setCategory('tshirts', this)">–ö–æ—Ñ—Ç—ã / –§—É—Ç–±–æ–ª–∫–∏</button>
                <button class="pill" onclick="setCategory('accessories', this)">–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</button>
                <button class="pill" onclick="setCategory('shoes', this)">–û–±—É–≤—å</button>
            </div>
        </div>

        <div class="grid" id="catalog">
            <div style="grid-column: span 2; text-align: center; padding: 40px; color: var(--hint);">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div id="article-view" class="article-view hidden">
            <div class="article-title">–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å —Å—É–º–∫—É –ø–æ–¥ –∑–∞–∫–∞–∑ ?</div>
            <div class="article-text">–ú—ã —Ä–∞–±–æ—Ç–∞–µ–º –ø–æ–¥ –∑–∞–∫–∞–∑ –∏–∑ –ï–≤—Ä–æ–ø—ã –∏ –ê–∑–∏–∏.

1) –ü—Ä–∏—à–ª–∏—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–µ–π –º–æ–¥–µ–ª–∏.

2) –ú—ã —Ä–∞—Å—Å—á–∏—Ç–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π.

3) –î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–Ω–µ—Å—Ç–∏ –∑–∞–¥–∞—Ç–æ–∫ 5000‚ÇΩ, –æ—Å—Ç–∞—Ç–æ–∫ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –°–î–≠–ö–æ–º.

–î–æ—Å—Ç–∞–≤–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –æ—Ç 10 –¥–æ 21 –¥–Ω—è –¥–æ –º–æ–º–µ–Ω—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –°–î–≠–ö–æ–º.</div>
            
            <div class="article-btn-container">
                <a href="https://t.me/dremalovo" class="btn-main">–°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏</a>
            </div>
        </div>
    </div>

    <div id="screen-fav" class="scroll-container hidden">
        <div class="header" style="display:flex; justify-content:center;">
            <div class="app-title">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
        </div>
        <div class="grid" id="fav-grid"></div>
    </div>

    <div id="product-modal" class="modal">
        <div class="modal-scroll-area">
            <div class="gallery-container">
                <div class="gallery-track" id="gallery-track"></div>
                <div class="modal-dots" id="modal-dots"></div>
                <svg class="fav-icon-svg modal-fav-pos" id="m-fav-btn" viewBox="0 0 24 24" onclick="toggleFavCurrent()">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
            </div>
            
            <div style="margin-top: 10px;">
                <div class="m-header">
                    <div class="m-price" id="m-price"></div>
                    <div class="m-name" id="m-name"></div>
                </div>
                <div class="separator"></div>
                <div class="m-desc" id="m-desc"></div>
            </div>
        </div>
        
        <div class="modal-actions">
            <a href="#" id="m-buy-btn" class="btn-main">–ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥–∞–≤—Ü—É</a>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('home', this)">
            <div class="tab-icon">
                <svg viewBox="0 0 24 24"><path d="M3 10v11h6v-7h6v7h6v-11L12 3z" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <div style="font-size: 10px; font-weight: 500;">–ì–ª–∞–≤–Ω–∞—è</div>
        </div>
        <div class="tab-item" onclick="switchTab('fav', this)">
            <div class="tab-icon">
                <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            </div>
            <div style="font-size: 10px; font-weight: 500;">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        try { tg.requestFullscreen(); } catch (e) {}
        
        // –ó–ê–©–ò–¢–ê –û–¢ –°–í–ê–ô–ü–ê
        tg.enableClosingConfirmation(); 

        tg.setHeaderColor('#1c1c1e'); 
        tg.setBackgroundColor('#1c1c1e');

        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSlz9ch-Zo9aFoJmlDbwpnHsIbUusWYja-1onKKlWEWifL21ApHup5nRz9QizS68fKTaJWHHIZOurOW/pub?gid=0&single=true&output=csv';
        const myNick = 'dremalovo'; 
        
        const logoUrl = ""; 

        if(logoUrl) {
            const logo = document.getElementById('brand-logo');
            logo.src = logoUrl;
            logo.style.display = 'block';
        }

        let products = [];
        let currentCategory = 'all';
        let currentSort = 'new';
        let currentProduct = null;
        let modalIndex = 0;
        let startX = 0;
        let lbIndex = 0;
        let lbStartX = 0;

        Papa.parse(sheetUrl, {
            download: true, header: true,
            complete: (res) => {
                products = res.data.filter(p => p.id && p.name);
                renderCatalog();
            }
        });

        function renderCatalog() {
            const list = document.getElementById('catalog');
            list.innerHTML = '';
            
            let filtered = products.filter(p => currentCategory === 'all' || p.category === currentCategory);

            if (currentSort === 'asc') {
                filtered.sort((a,b) => parseInt(a.price.replace(/\D/g,'')) - parseInt(b.price.replace(/\D/g,'')));
            } else if (currentSort === 'desc') {
                filtered.sort((a,b) => parseInt(b.price.replace(/\D/g,'')) - parseInt(a.price.replace(/\D/g,'')));
            } else if (currentSort === 'new') {
                filtered.sort((a,b) => parseInt(b.id) - parseInt(a.id));
            } else if (currentSort === 'avito') {
                filtered = filtered.filter(p => p.description && p.description.toLowerCase().includes('–∞–≤–∏—Ç–æ'));
            }

            if(!filtered.length) {
                list.innerHTML = '<div style="color:var(--hint); text-align:center; padding:20px; grid-column:span 2">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</div>';
                return;
            }

            filtered.forEach((p, index) => {
                const images = p.images ? p.images.split(',').map(s=>s.trim()) : [];
                const isFav = localStorage.getItem(`fav_${p.id}`);
                
                let slidesHtml = images.slice(0,5).map(img => `
                    <div class="card-slide" onclick="openProduct('${p.id}')">
                        <img src="${img}" loading="lazy">
                    </div>
                `).join('');

                let dotsHtml = '';
                if(images.length > 1) {
                    dotsHtml = `<div class="dots-row">
                        ${images.slice(0,5).map((_,i) => `<div class="c-dot ${i===0?'active':''}"></div>`).join('')}
                    </div>`;
                } else { dotsHtml = `<div class="dots-row"></div>`; }

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    ${(currentSort==='new' && index<3) ? '<div class="badge-new">NEW</div>' : ''}
                    <div class="card-slider" onscroll="updateCardDots(this)">${slidesHtml}</div>
                    
                    <svg class="fav-icon-svg ${isFav?'liked':''}" viewBox="0 0 24 24" onclick="toggleFavFromCard(this, '${p.id}')">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>

                    ${dotsHtml}
                    
                    <div class="card-info" onclick="openProduct('${p.id}')">
                        <div class="price">${p.price} ‚ÇΩ</div>
                        <div class="name">${p.name}</div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        window.updateCardDots = function(el) {
            const index = Math.round(el.scrollLeft / el.offsetWidth);
            const dots = el.parentElement.querySelectorAll('.c-dot');
            dots.forEach((d, i) => d.classList.toggle('active', i === index));
        }

        window.showArticle = function(btn) {
            document.querySelectorAll('.pill').forEach(el=>el.classList.remove('active'));
            btn.classList.add('active');
            
            document.querySelectorAll('.scroll-container').forEach(el => el.classList.add('hidden'));
            document.getElementById('screen-home').classList.remove('hidden');

            document.getElementById('catalog').classList.add('hidden');
            document.getElementById('article-view').classList.remove('hidden');
            document.getElementById('article-view').style.display = 'block';
        }

        window.setCategory = function(c, b) { 
            document.querySelectorAll('.pill').forEach(el=>el.classList.remove('active')); 
            b.classList.add('active'); 
            currentCategory = c; 
            
            document.querySelectorAll('.scroll-container').forEach(el => el.classList.add('hidden'));
            document.getElementById('screen-home').classList.remove('hidden');
            
            document.getElementById('catalog').classList.remove('hidden');
            document.getElementById('article-view').classList.add('hidden');
            document.getElementById('article-view').style.display = 'none';
            renderCatalog(); 
        }

        function openProduct(id) {
            const p = products.find(x => x.id === id);
            if(!p) return;
            currentProduct = p;
            modalIndex = 0;
            
            document.getElementById('m-name').innerText = p.name;
            document.getElementById('m-price').innerText = p.price + ' ‚ÇΩ';
            document.getElementById('m-desc').innerText = p.description || '';
            
            const firstImg = p.images ? p.images.split(',')[0].trim() : '';
            const text = `–ü—Ä–∏–≤–µ—Ç! –•–æ—á—É –∫—É–ø–∏—Ç—å ${p.name} (${firstImg})`;
            document.getElementById('m-buy-btn').href = `https://t.me/${myNick}?text=${encodeURIComponent(text)}`;
            
            updateModalFavIcon();
            renderModalGallery();
            
            const modal = document.getElementById('product-modal');
            modal.classList.add('open');
            tg.BackButton.show();
            tg.BackButton.onClick(closeModal);
        }

        function closeModal() {
            document.getElementById('product-modal').classList.remove('open');
            tg.BackButton.hide();
        }

        function renderModalGallery() {
            const track = document.getElementById('gallery-track');
            const dotsContainer = document.getElementById('modal-dots');
            const images = currentProduct.images.split(',').map(s => s.trim());
            
            track.innerHTML = images.map((src, i) => `
                <div class="gallery-item">
                    <img src="${src}" onclick="openLightbox(${i})">
                </div>
            `).join('');
            
            if(images.length > 1) {
                dotsContainer.innerHTML = images.map((_, i) => `<div class="m-dot ${i===0?'active':''}"></div>`).join('');
            } else { dotsContainer.innerHTML = ''; }
            
            track.style.transform = `translateX(0px)`;
            
            const container = document.querySelector('.gallery-container');
            container.ontouchstart = mTouchStart;
            container.ontouchmove = mTouchMove;
            container.ontouchend = mTouchEnd;
        }

        function mTouchStart(e) { startX = e.touches[0].clientX; }
        function mTouchMove(e) {
            const diff = e.touches[0].clientX - startX;
            const track = document.getElementById('gallery-track');
            const currentPercent = -(modalIndex * 100);
            const diffPercent = (diff / track.offsetWidth) * 100;
            track.style.transform = `translateX(${currentPercent + diffPercent}%)`;
        }
        function mTouchEnd(e) {
            const diff = e.changedTouches[0].clientX - startX;
            const images = currentProduct.images.split(',');
            if (Math.abs(diff) > 50) {
                if (diff > 0 && modalIndex > 0) modalIndex--;
                else if (diff < 0 && modalIndex < images.length - 1) modalIndex++;
            }
            updateModalSlider();
        }
        function updateModalSlider() {
            const track = document.getElementById('gallery-track');
            track.style.transition = 'transform 0.3s ease-out';
            track.style.transform = `translateX(-${modalIndex * 100}%)`;
            setTimeout(() => { track.style.transition = 'none'; }, 300);
            
            const dots = document.querySelectorAll('.m-dot');
            dots.forEach((d,i) => d.classList.toggle('active', i === modalIndex));
        }

        window.openLightbox = function(index) {
            lbIndex = index;
            const images = currentProduct.images.split(',').map(s => s.trim());
            const track = document.getElementById('lb-track');
            track.innerHTML = images.map(src => `<div class="lb-item"><img src="${src}"></div>`).join('');
            updateLightboxView();
            document.getElementById('lightbox').classList.add('show');
            const lb = document.getElementById('lightbox');
            lb.ontouchstart = (e) => { lbStartX = e.touches[0].clientX; };
            lb.ontouchmove = (e) => {
                const diff = e.touches[0].clientX - lbStartX;
                track.style.transform = `translateX(${-(lbIndex * 100) + (diff / window.innerWidth * 100)}vw)`;
            };
            lb.ontouchend = (e) => {
                const diff = e.changedTouches[0].clientX - lbStartX;
                if (Math.abs(diff) > 50) {
                    if (diff > 0 && lbIndex > 0) lbIndex--;
                    else if (diff < 0 && lbIndex < images.length - 1) lbIndex++;
                }
                updateLightboxView();
            };
        }

        function updateLightboxView() {
            const track = document.getElementById('lb-track');
            const total = currentProduct.images.split(',').length;
            track.style.transition = 'transform 0.3s ease-out';
            track.style.transform = `translateX(-${lbIndex * 100}vw)`;
            setTimeout(() => { track.style.transition = 'none'; }, 300);
            document.getElementById('lb-counter').innerText = `${lbIndex + 1} / ${total}`;
        }
        window.closeZoom = function() { document.getElementById('lightbox').classList.remove('show'); }

        function toggleFavFromCard(btn, id) {
            const svg = btn.closest('svg') || btn;
            toggleFavLogic(id);
            if(localStorage.getItem(`fav_${id}`)) svg.classList.add('liked');
            else svg.classList.remove('liked');
        }
        function toggleFavCurrent() {
            if(!currentProduct) return;
            toggleFavLogic(currentProduct.id);
            updateModalFavIcon();
            if(document.getElementById('screen-fav').classList.contains('hidden') === false) renderFavs();
        }
        function toggleFavLogic(id) {
            if (localStorage.getItem(`fav_${id}`)) {
                localStorage.removeItem(`fav_${id}`);
                showToast("–£–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ");
            } else {
                localStorage.setItem(`fav_${id}`, '1');
                showToast("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ");
                if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            }
        }
        function updateModalFavIcon() {
            const isFav = localStorage.getItem(`fav_${currentProduct.id}`);
            const btn = document.getElementById('m-fav-btn');
            if(isFav) btn.classList.add('liked');
            else btn.classList.remove('liked');
        }

        function renderFavs() {
            const list = document.getElementById('fav-grid');
            list.innerHTML = '';
            const favs = products.filter(p => localStorage.getItem(`fav_${p.id}`));
            if (!favs.length) { list.innerHTML = '<div style="grid-column:span 2; text-align:center; padding:50px; color:var(--hint)">–ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ üíî</div>'; return; }
            
            favs.forEach(p => {
                const img = p.images.split(',')[0].trim();
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <div class="card-slider"><img src="${img}" style="width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:14px" onclick="openProduct('${p.id}')"></div>
                    <svg class="fav-icon-svg liked" viewBox="0 0 24 24" onclick="toggleFavFromCard(this, '${p.id}')">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                    <div class="dots-row"></div>
                    <div class="card-info" onclick="openProduct('${p.id}')">
                        <div class="price">${p.price} ‚ÇΩ</div>
                        <div class="name">${p.name}</div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        function switchTab(tab, btn) {
            document.querySelectorAll('.tab-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // –°–ö–†–´–í–ê–ï–ú –í–°–ï –≠–ö–†–ê–ù–´
            document.querySelectorAll('.scroll-container').forEach(el => el.classList.add('hidden'));
            
            if (tab === 'home') {
                document.getElementById('screen-home').classList.remove('hidden');
            } else {
                document.getElementById('screen-fav').classList.remove('hidden');
                renderFavs();
            }
        }

        window.applySort = (t) => { currentSort = t; renderCatalog(); }
    </script>
</body>
</html>